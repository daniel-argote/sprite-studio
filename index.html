<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Studio v1.2</title>
    <!-- Built with the assistance of Google Gemini -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: ui-sans-serif, system-ui; }
        .checkerboard { 
            background-image: 
                linear-gradient(45deg, #1e293b 25%, transparent 25%), 
                linear-gradient(-45deg, #1e293b 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1e293b 75%), 
                linear-gradient(-45deg, transparent 75%, #1e293b 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        canvas { cursor: crosshair; image-rendering: pixelated; }
        input[type=range], input[type=checkbox] { accent-color: #10b981; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="border-b border-slate-800 p-4 flex items-center justify-between bg-slate-900 shadow-xl z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
            </div>
            <h1 class="text-xl font-bold tracking-tight">Sprite Studio <span class="text-xs font-normal text-slate-500 ml-2">Universal Asset Tool</span></h1>
        </div>
        <div id="status-text" class="text-sm text-slate-400 italic">Ready for any sprite...</div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-80 border-r border-slate-800 p-6 bg-slate-900/50 overflow-y-auto space-y-8">
            
            <section>
                <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 block mb-3">1. Background Color</label>
                <div class="flex items-center gap-3 p-3 bg-slate-800 rounded-lg border border-slate-700">
                    <input type="color" id="targetColor" value="#ffffff" class="w-10 h-10 rounded bg-transparent cursor-pointer">
                    <div class="flex-1">
                        <div class="text-slate-300 font-mono text-sm" id="hexDisplay">#FFFFFF</div>
                        <div class="text-[10px] text-emerald-500 font-bold">CLICK PREVIEW TO SAMPLE</div>
                    </div>
                </div>
            </section>

            <section class="space-y-6">
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <label class="font-semibold text-slate-300">Tolerance</label>
                        <span id="toleranceVal" class="text-emerald-400 font-bold">30</span>
                    </div>
                    <input type="range" id="tolerance" min="0" max="150" value="30" class="w-full cursor-pointer">
                </div>

                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <label class="font-semibold text-slate-300">Edge Smoothing</label>
                        <span id="smoothVal" class="text-emerald-400 font-bold">1</span>
                    </div>
                    <input type="range" id="smoothness" min="0" max="10" value="1" class="w-full cursor-pointer">
                </div>

                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <label class="font-semibold text-slate-300">Preview Zoom</label>
                        <span id="zoomVal" class="text-emerald-400 font-bold">100%</span>
                    </div>
                    <input type="range" id="zoom" min="50" max="400" value="100" class="w-full cursor-pointer">
                </div>
            </section>

            <section class="pt-6 border-t border-slate-800 space-y-3">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="askFileName" class="w-4 h-4 cursor-pointer">
                    <label for="askFileName" class="text-sm text-slate-400 cursor-pointer select-none">Ask for filename</label>
                </div>
                <div class="flex gap-2">
                    <button id="resetBtn" class="px-4 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-red-400 rounded-xl transition-colors" title="Discard & New Image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                    <button id="downloadBtn" disabled class="flex-1 py-4 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 disabled:text-slate-600 rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Export PNG
                    </button>
                </div>
                <button id="downloadSvgBtn" disabled class="w-full py-3 bg-slate-800 hover:bg-slate-700 disabled:bg-slate-900 disabled:text-slate-700 text-slate-300 hover:text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 text-sm border border-slate-700 hover:border-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M9 15l2 2 4-4"></path></svg>
                    Export as SVG
                </button>
            </section>
        </aside>

        <!-- Main Workspace -->
        <div class="flex-1 relative flex items-center justify-center bg-slate-950 overflow-hidden">
            <div id="drop-zone" class="absolute inset-0 z-10 flex flex-col items-center justify-center border-4 border-dashed border-slate-800 m-12 rounded-3xl transition-all">
                <div class="p-6 bg-slate-900 rounded-full mb-4">
                    <svg class="text-emerald-500" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><circle cx="10" cy="13" r="2"></circle><path d="m20 17-1.09-1.09a2 2 0 0 0-2.82 0L10 22"></path></svg>
                </div>
                <p class="text-slate-400 text-xl font-medium">Drop or Paste (Ctrl+V) sprite here</p>
                <p class="text-slate-600 text-sm mt-2">Works with trees, characters, or UI elements</p>
                <input type="file" id="fileInput" class="hidden" accept="image/*">
                <button onclick="document.getElementById('fileInput').click()" class="mt-6 px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-semibold transition-all">Select File</button>
            </div>

            <div id="canvas-wrapper" class="checkerboard shadow-2xl rounded-lg hidden overflow-auto max-w-[90%] max-h-[90%] border border-slate-700">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>
    </main>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        const toleranceInput = document.getElementById('tolerance');
        const toleranceVal = document.getElementById('toleranceVal');
        const smoothnessInput = document.getElementById('smoothness');
        const smoothVal = document.getElementById('smoothVal');
        const zoomInput = document.getElementById('zoom');
        const zoomVal = document.getElementById('zoomVal');
        const targetColorInput = document.getElementById('targetColor');
        const hexDisplay = document.getElementById('hexDisplay');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadSvgBtn = document.getElementById('downloadSvgBtn');
        const resetBtn = document.getElementById('resetBtn');
        const askFileName = document.getElementById('askFileName');
        const statusText = document.getElementById('status-text');

        let originalImage = null;

        // --- Interaction ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-slate-800/50'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-slate-800/50'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    handleFile(item.getAsFile());
                    break;
                }
            }
        });

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    dropZone.classList.add('hidden');
                    canvasWrapper.classList.remove('hidden');
                    downloadBtn.disabled = false;
                    downloadSvgBtn.disabled = false;
                    statusText.innerText = `Sprite: ${file.name || "Pasted Image"}`;
                    processImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Sampling ---
        canvas.addEventListener('mousedown', (e) => {
            if (!originalImage) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            // Temporary draw of original to get true color
            ctx.drawImage(originalImage, 0, 0);
            const p = ctx.getImageData(x, y, 1, 1).data;
            const hex = "#" + [p[0], p[1], p[2]].map(x => x.toString(16).padStart(2, '0')).join('');
            targetColorInput.value = hex;
            processImage();
        });

        // --- Image Processing ---
        function processImage() {
            if (!originalImage) return;

            const w = originalImage.width;
            const h = originalImage.height;
            const zoom = parseInt(zoomInput.value) / 100;
            
            canvas.width = w;
            canvas.height = h;
            canvas.style.width = (w * zoom) + "px";
            canvas.style.height = (h * zoom) + "px";
            zoomVal.innerText = zoomInput.value + "%";

            ctx.drawImage(originalImage, 0, 0);

            const hex = targetColorInput.value;
            hexDisplay.innerText = hex.toUpperCase();
            const rT = parseInt(hex.slice(1, 3), 16);
            const gT = parseInt(hex.slice(3, 5), 16);
            const bT = parseInt(hex.slice(5, 7), 16);
            const tol = parseInt(toleranceInput.value);
            const smooth = parseInt(smoothnessInput.value);
            
            toleranceVal.innerText = tol;
            smoothVal.innerText = smooth;

            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i+1];
                const b = data[i+2];

                const dist = Math.sqrt(Math.pow(r-rT, 2) + Math.pow(g-gT, 2) + Math.pow(b-bT, 2));

                if (dist <= tol) {
                    data[i+3] = 0;
                } else if (smooth > 0 && dist <= tol + smooth * 10) {
                    // Gradual alpha falloff for smoother edges
                    const factor = (dist - tol) / (smooth * 10);
                    data[i+3] = Math.min(data[i+3], factor * 255);
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        [toleranceInput, smoothnessInput, zoomInput, targetColorInput].forEach(el => {
            el.addEventListener('input', processImage);
        });

        downloadBtn.addEventListener('click', () => {
            let fileName = 'sprite_asset.png';
            if (askFileName.checked) {
                const input = prompt('Enter filename:', 'sprite_asset');
                if (input === null) return;
                fileName = (input.trim() || 'sprite_asset');
                if (!fileName.toLowerCase().endsWith('.png')) fileName += '.png';
            }

            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        downloadSvgBtn.addEventListener('click', () => {
            if (!originalImage) return;

            let fileName = 'sprite_asset.svg';
            if (askFileName.checked) {
                const input = prompt('Enter filename:', 'sprite_asset');
                if (input === null) return;
                fileName = (input.trim() || 'sprite_asset');
                if (!fileName.toLowerCase().endsWith('.svg')) fileName += '.svg';
            }

            const w = canvas.width;
            const h = canvas.height;
            const data = ctx.getImageData(0, 0, w, h).data;
            
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" shape-rendering="crispEdges">`;
            
            // Run-Length Encoding for optimization
            for (let y = 0; y < h; y++) {
                let currentFill = null;
                let startX = 0;
                
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;
                    const a = data[i+3];
                    let fill = null;
                    
                    if (a > 0) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        fill = a === 255 
                            ? "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)
                            : `rgba(${r},${g},${b},${(a/255).toFixed(3)})`;
                    }
                    
                    if (fill !== currentFill) {
                        if (currentFill) {
                            svg += `<rect x="${startX}" y="${y}" width="${x - startX}" height="1" fill="${currentFill}" />`;
                        }
                        currentFill = fill;
                        startX = x;
                    }
                }
                if (currentFill) {
                    svg += `<rect x="${startX}" y="${y}" width="${w - startX}" height="1" fill="${currentFill}" />`;
                }
            }
            svg += '</svg>';
            
            const blob = new Blob([svg], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = fileName;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        });

        resetBtn.addEventListener('click', () => {
            originalImage = null;
            dropZone.classList.remove('hidden');
            canvasWrapper.classList.add('hidden');
            downloadBtn.disabled = true;
            downloadSvgBtn.disabled = true;
            statusText.innerText = "Ready for any sprite...";
            fileInput.value = '';
        });
    </script>
</body>
</html>